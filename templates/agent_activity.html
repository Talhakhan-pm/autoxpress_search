<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoXpress Agent Activity</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', sans-serif;
        }

        .main-container {
            max-width: 95%;
            margin: 30px auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h3 {
            color: #2c3e50;
            font-weight: 600;
            position: relative;
            padding-bottom: 10px;
        }

        h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 3px;
            background: #3498db;
            border-radius: 2px;
        }

        /* Stats cards */
        .stats-card {
            border-radius: 10px;
            padding: 15px;
            color: white;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .stats-card h4 {
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .stats-card .value {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .stats-inbound {
            background: linear-gradient(45deg, #3498db, #2980b9);
        }

        .stats-outbound {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
        }

        .stats-missed {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .stats-total {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
        }
        
        /* Agent Activity Cards */
        .agent-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            padding: 15px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .agent-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        
        .agent-card .agent-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #2c3e50;
            margin-bottom: 10px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }
        
        .agent-card .agent-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .agent-card .stat-item {
            flex: 1 0 45%;
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 8px;
            text-align: center;
        }
        
        .agent-card .stat-label {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 3px;
        }
        
        .agent-card .stat-value {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.2rem;
        }
        
        .agent-card .trend-up {
            color: #2ecc71;
        }
        
        .agent-card .trend-down {
            color: #e74c3c;
        }
        
        .agent-card .agent-chart {
            height: 100px;
            margin-top: 15px;
        }

        /* Navigation */
        .nav-item.active {
            background-color: #3498db;
            border-radius: 5px;
        }
        
        .nav-item.active a {
            color: white !important;
        }
        
        .nav-tabs {
            border-bottom: 2px solid #3498db;
            margin-bottom: 20px;
        }
        
        .nav-link {
            color: #2c3e50;
            font-weight: 500;
            padding: 10px 15px;
            border-radius: 5px 5px 0 0;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            background-color: #ecf0f1;
        }
        
        .btn-custom-red {
            background-color: #fff !important;
            color: #e74c3c;
            border: 2px solid #e74c3c;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .btn-custom-red:hover,
        .btn-custom-red:focus {
            background-color: #e74c3c !important;
            color: #fff;
            border-color: #e74c3c;
            box-shadow: 0 0 8px rgba(231, 76, 60, 0.3);
            transform: scale(1.02);
        }
    </style>
</head>

<body>
    <div class="main-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <a href="/" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-home"></i> Home
                </a>
            </div>
            <h3 class="text-center">AutoXpress Agent Activity</h3>
            <div>
                <a href="/callbacks.html" class="btn btn-custom-red btn-sm me-2">Callbacks</a>
                <a href="https://assistant-autoxpress.onrender.com/" class="btn btn-custom-red btn-sm">AI Assistant</a>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item active">
                <a class="nav-link active" href="/agent_activity">
                    <i class="fas fa-headset me-2"></i>Agent Activity
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/call_tables">
                    <i class="fas fa-phone-alt me-2"></i>Call Tables
                </a>
            </li>
        </ul>

        <!-- Call Handling Information Alert -->
        <div class="alert alert-info mb-4">
            <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>About Call Handling</h5>
            <p>This dashboard shows all call activity in the AutoXpress department. When an inbound call comes to the department, Dialpad rings multiple agents simultaneously, but only the agent who answered is credited with the call.</p>
            <p class="mb-0"><strong>Note:</strong> Missed calls are deduplicated to show each customer call only once, regardless of how many agents were initially called.</p>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card stats-inbound">
                    <h4><i class="fas fa-phone-alt me-2"></i>Inbound Calls</h4>
                    <div class="value" id="inboundCount">0</div>
                    <div class="small">Completed calls</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card stats-outbound">
                    <h4><i class="fas fa-phone-volume me-2"></i>Outbound Calls</h4>
                    <div class="value" id="outboundCount">0</div>
                    <div class="small">Completed calls</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card stats-missed">
                    <h4><i class="fas fa-phone-slash me-2"></i>Missed Calls</h4>
                    <div class="value" id="missedCount">0</div>
                    <div class="small">Not answered</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card stats-total">
                    <h4><i class="fas fa-chart-line me-2"></i>Total Calls</h4>
                    <div class="value" id="totalCount">0</div>
                    <div class="small">All call interactions</div>
                </div>
            </div>
        </div>
        
        <!-- Agent Activity Section -->
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3 agent-activity-header">
                <h4 class="text-dark"><i class="fas fa-headset me-2"></i>Agent Activity</h4>
                <div class="d-flex align-items-center">
                    <button id="manualRefreshBtn" class="btn btn-sm btn-outline-primary me-2">
                        <i class="fas fa-sync-alt me-1"></i> Refresh
                    </button>
                    <div class="d-flex align-items-center date-range-picker">
                        <input type="date" class="form-control form-control-sm me-2" id="startDate" aria-label="Start date">
                        <span class="text-muted small">to</span>
                        <input type="date" class="form-control form-control-sm ms-2 me-2" id="endDate" aria-label="End date">
                        <button id="applyDateRange" class="btn btn-sm btn-primary">
                            <i class="fas fa-calendar-check me-1"></i> Apply
                        </button>
                    </div>
                </div>
            </div>
            <div class="row" id="agentActivityCards">
                <!-- Agent cards will be loaded here dynamically -->
                <div class="col-12 text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading agent activity...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                Data loaded successfully!
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize variables
            const toast = new bootstrap.Toast(document.getElementById('notificationToast'));
            
            // Cache settings
            const CACHE_KEY_PREFIX = 'dialpad_activity_';
            const CACHE_EXPIRY = 1000 * 60 * 60; // 1 hour cache expiry
            
            // Initialize date pickers with default values
            const today = new Date();
            
            // Format current date in YYYY-MM-DD format
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            // Set date values - ensure no future dates
            document.getElementById('endDate').value = formatDate(today);
            document.getElementById('startDate').value = formatDate(yesterday);
            
            // Setup date range picker
            document.getElementById('applyDateRange').addEventListener('click', function() {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (!startDate || !endDate) {
                    alert('Please select both start and end dates');
                    return;
                }
                
                // Validate date range
                if (new Date(startDate) > new Date(endDate)) {
                    alert('Start date cannot be after end date');
                    return;
                }
                
                loadAgentActivityByDateRange(startDate, endDate, false);
            });
            
            // Setup manual refresh button
            document.getElementById('manualRefreshBtn').addEventListener('click', function() {
                // Force refresh using current date range
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (startDate && endDate) {
                    loadAgentActivityByDateRange(startDate, endDate, true);
                } else {
                    // Default to yesterday-today if no dates selected
                    loadAgentActivityByDateRange(
                        yesterday.toISOString().split('T')[0],
                        today.toISOString().split('T')[0],
                        true
                    );
                }
            });

            // Local storage cache helper functions
            function getCachedData(cacheKey) {
                try {
                    const cachedItem = localStorage.getItem(cacheKey);
                    if (!cachedItem) return null;
                    
                    const cachedData = JSON.parse(cachedItem);
                    const now = new Date().getTime();
                    
                    // Check if cache is expired
                    if (now > cachedData.expiry) {
                        localStorage.removeItem(cacheKey);
                        return null;
                    }
                    
                    return cachedData.data;
                } catch (error) {
                    console.error('Error reading from cache:', error);
                    return null;
                }
            }
            
            function setCachedData(cacheKey, data) {
                try {
                    const cacheData = {
                        data: data,
                        expiry: new Date().getTime() + CACHE_EXPIRY,
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem(cacheKey, JSON.stringify(cacheData));
                    console.log(`Cached data for key: ${cacheKey}`);
                } catch (error) {
                    console.error('Error writing to cache:', error);
                }
            }

            // Function to load agent activity data by date range
            function loadAgentActivityByDateRange(startDate, endDate, forceRefresh = false) {
                const activityContainer = document.getElementById('agentActivityCards');
                
                // Show loading state
                activityContainer.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading agent activity...</p>
                        <p class="small text-muted">${forceRefresh ? 'Refreshing data from Dialpad API...' : ''}</p>
                    </div>
                `;
                
                // Create cache key based on date range
                const cacheKey = `${CACHE_KEY_PREFIX}${startDate}_${endDate}`;
                
                // Check cache first if not forcing refresh
                if (!forceRefresh) {
                    const cachedData = getCachedData(cacheKey);
                    if (cachedData) {
                        console.log(`Using cached data for ${startDate} to ${endDate}`);
                        renderAgentActivity(cachedData);
                        updateStats(cachedData);
                        
                        // Show toast notification
                        document.getElementById('toastMessage').textContent = 'Loaded agent activity from cache';
                        toast.show();
                        return;
                    }
                    console.log(`No cache found for ${startDate} to ${endDate}, fetching from API...`);
                }
                
                // Fetch agent activity data from API
                console.log(`Fetching agent activity data from ${startDate} to ${endDate}${forceRefresh ? ' with refresh' : ''}...`);
                
                // Set a timeout to show a message if it's taking too long
                const loadingTimeout = setTimeout(() => {
                    activityContainer.innerHTML = `
                        <div class="col-12 text-center py-4">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Taking longer than expected...</strong>
                                <p class="mb-0 mt-2">Retrieving call data from Dialpad API. This might take a minute for large datasets.</p>
                                <p class="mt-2">You can continue using the UI while we load this data.</p>
                            </div>
                        </div>
                    `;
                }, 15000); // Show after 15 seconds
                
                // Fetch data from API
                fetch(`/api/agent-activity?start_date=${startDate}&end_date=${endDate}&refresh=${forceRefresh}&max_timeout=60`)
                    .then(response => {
                        // Clear the timeout when we get a response
                        clearTimeout(loadingTimeout);
                        
                        if (!response.ok) {
                            console.error('API response not OK:', response.status, response.statusText);
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Agent activity API response:', data);
                        if (data.success) {
                            console.log('Agent activity data:', data.activity);
                            
                            // Cache the results
                            setCachedData(cacheKey, data.activity);
                            
                            renderAgentActivity(data.activity);
                            updateStats(data.activity);
                            
                            // Show toast notification
                            document.getElementById('toastMessage').textContent = 'Agent activity data refreshed';
                            toast.show();
                        } else {
                            console.error('API error:', data.error);
                            throw new Error(data.error || 'Failed to load agent activity');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading agent activity:', error);
                        activityContainer.innerHTML = `
                            <div class="col-12 text-center py-4">
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Error loading agent activity: ${error.message}
                                </div>
                            </div>
                        `;
                    });
            }
            }
            
            // Function to render agent activity cards
            function renderAgentActivity(activityData) {
                const container = document.getElementById('agentActivityCards');
                console.log('Rendering agent activity with data:', activityData);
                
                if (!activityData) {
                    console.error('No activity data provided to renderAgentActivity');
                    container.innerHTML = `
                        <div class="col-12 text-center py-4">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                Error: No activity data received from server.
                            </div>
                        </div>
                    `;
                    return;
                }
                
                const agents = activityData.agents;
                console.log('Agents array:', agents);
                
                if (!agents || agents.length === 0) {
                    console.log('No agents found in activity data');
                    container.innerHTML = `
                        <div class="col-12 text-center py-4">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                No agent activity data available for the selected period.
                            </div>
                            <p class="mt-3">
                                <button id="refreshActivityBtn" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-sync-alt me-2"></i>Refresh Data
                                </button>
                            </p>
                        </div>
                    `;
                    
                    // Add event listener to refresh button
                    setTimeout(() => {
                        const refreshBtn = document.getElementById('refreshActivityBtn');
                        if (refreshBtn) {
                            refreshBtn.addEventListener('click', function() {
                                loadAgentActivity(parseInt(document.getElementById('activityPeriod').value), true);
                            });
                        }
                    }, 100);
                    
                    return;
                }
                
                // Generate HTML for agent cards
                let html = '';
                
                agents.forEach(agent => {
                    // We no longer use efficiency since we're only showing completed calls
                    
                    html += `
                        <div class="col-md-4">
                            <div class="agent-card">
                                <div class="agent-name">
                                    <i class="fas fa-headset me-2"></i>${agent.agent_name}
                                </div>
                                <div class="agent-stats">
                                    <div class="stat-item">
                                        <div class="stat-label">Completed Calls</div>
                                        <div class="stat-value">${agent.completed_calls}</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-label">Inbound</div>
                                        <div class="stat-value">${agent.inbound_calls}</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-label">Outbound</div>
                                        <div class="stat-value">${agent.outbound_calls}</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-label">Avg Duration</div>
                                        <div class="stat-value">${agent.avg_duration} min</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                // Update the container
                container.innerHTML = html;
                
                // Add period info
                const periodInfo = document.createElement('div');
                periodInfo.className = 'col-12 text-center mb-3';
                periodInfo.innerHTML = `
                    <small class="text-muted">
                        Showing data from ${activityData.from_date} to ${activityData.to_date} 
                        (${activityData.period_days} days) · Total calls: ${activityData.total_calls}
                    </small>
                `;
                container.insertAdjacentElement('afterbegin', periodInfo);
            }
            
            // Function to update stats cards
            function updateStats(activityData) {
                // Calculate stats from agents data
                let inboundTotal = 0;
                let outboundTotal = 0;
                let missedTotal = 0;
                let totalCalls = 0;
                
                // Check if we have the new missed_calls field in the data
                if (activityData.missed_calls !== undefined) {
                    missedTotal = activityData.missed_calls || 0;
                }
                
                if (activityData.agents && activityData.agents.length > 0) {
                    activityData.agents.forEach(agent => {
                        // Count completed calls
                        inboundTotal += (agent.inbound_calls) ? agent.inbound_calls : 0;
                        outboundTotal += (agent.outbound_calls) ? agent.outbound_calls : 0;
                    });
                }
                
                // For backward compatibility
                if (activityData.total_completed_calls !== undefined) {
                    let completedTotal = activityData.total_completed_calls || 0;
                    totalCalls = completedTotal + missedTotal;
                } else if (activityData.total_calls !== undefined) {
                    totalCalls = activityData.total_calls || 0;
                } else {
                    totalCalls = inboundTotal + outboundTotal + missedTotal;
                }
                
                // Update the stats cards
                document.getElementById('inboundCount').textContent = inboundTotal;
                document.getElementById('outboundCount').textContent = outboundTotal;
                document.getElementById('missedCount').textContent = missedTotal;
                document.getElementById('totalCount').textContent = totalCalls;
            }
            
            // Initialize the page
            console.log("Loading agent activity...");
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            loadAgentActivityByDateRange(startDate, endDate, false); // Load with default date range
        });
    </script>
</body>

</html>